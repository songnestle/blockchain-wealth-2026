# 技术架构文档

## 技术实现

### 技术栈

**前端：**
- React 18.2.0 - 用户界面框架
- Vite 5.0.8 - 构建工具和开发服务器
- Recharts 2.10.3 - K线图和数据可视化
- Axios 1.6.2 - HTTP 请求库

**后端：**
- Python 3.x
- Flask - Web 框架
- Flask-CORS - 跨域资源共享

**AI 服务：**
- Google Gemini API - 图像识别和数据分析
- Alibaba Qwen API - 中文语言模型
- Claude API - 高级推理和分析
- DeepSeek API - 备用 AI 服务

**数据库：**
- 无持久化数据库（使用 localStorage 存储客户端数据）

**部署环境：**
- 前端：Vercel / Netlify（静态托管）
- 后端：本地开发服务器（Flask）
- 端口：前端 3000，后端 5000

**主要依赖库：**
```json
{
  "前端": {
    "@google/generative-ai": "^0.24.1",
    "axios": "^1.6.2",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "recharts": "^2.10.3"
  },
  "后端": {
    "flask": "最新版本",
    "flask-cors": "最新版本",
    "pandas": "数据处理",
    "numpy": "数值计算",
    "python-dateutil": "日期处理"
  }
}
```

### 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         用户浏览器                            │
│  ┌───────────────────────────────────────────────────────┐  │
│  │              React 前端应用 (Vite)                     │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │  │
│  │  │ 数据输入模块  │  │  报告展示模块 │  │ 图表模块     │ │  │
│  │  │ (截图/CSV)   │  │  (AI分析结果) │  │ (K线图)     │ │  │
│  │  └──────────────┘  └──────────────┘  └─────────────┘ │  │
│  │  ┌──────────────────────────────────────────────────┐ │  │
│  │  │          赞助模块 (Solana USDC)                   │ │  │
│  │  └──────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │ HTTP/HTTPS
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Flask 后端服务器                          │
│  ┌───────────────────────────────────────────────────────┐  │
│  │              API 路由层                                │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │  │
│  │  │ 八字计算模块  │  │  数据处理模块 │  │ 趋势分析    │ │  │
│  │  │ (农历转换)   │  │  (CSV解析)   │  │ (预测生成)  │ │  │
│  │  └──────────────┘  └──────────────┘  └─────────────┘ │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │ API 调用
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      AI 服务层                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ Gemini   │  │  Qwen    │  │  Claude  │  │ DeepSeek │   │
│  │ (图像识别)│  │ (中文AI) │  │ (推理)   │  │ (备用)   │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 核心功能模块

#### 1. 数据输入模块 (IntegratedInput)
**功能描述：**
- 支持截图上传（交易记录、资金变动）
- 支持 CSV 文件上传（账户明细）
- 用户基本信息输入（姓名、性别、出生日期）
- 自动触发 AI 分析流程

**技术实现：**
- FileReader API 读取文件
- Base64 编码图片数据
- CSV 文本解析
- 表单验证和状态管理

#### 2. AI 分析引擎
**功能描述：**
- 多模态 AI 协同分析
- 图像识别提取交易数据
- 自然语言生成分析报告
- 八字命理计算和融合

**技术实现：**
- Gemini Vision API - 图像内容识别
- Qwen/Claude/DeepSeek - 文本分析和报告生成
- 农历转换算法 - 八字计算
- Prompt Engineering - 结构化输出

#### 3. 报告展示模块 (IntegratedReport)
**功能描述：**
- 展示 2026 年度趋势分析
- 财富趋势评估
- 人生趋势预测
- 风险提示和建议

**技术实现：**
- React 组件化设计
- 动态数据渲染
- 响应式布局
- CSS 样式优化

#### 4. 数据可视化模块 (KLineChart)
**功能描述：**
- K线图展示人生趋势
- 区间图表（高点、低点、平均值）
- 时间轴展示（月度数据）
- 交互式图表

**技术实现：**
- Recharts 图表库
- ComposedChart 组合图表
- 自定义 Tooltip
- 颜色主题配置

#### 5. 赞助支付模块 (SolanaPayment)
**功能描述：**
- 显示 Solana USDC 收款地址
- 生成支付二维码
- 一键复制地址
- 支持所有 Solana 钱包

**技术实现：**
- QR Code API 生成二维码
- Clipboard API 复制功能
- 静态地址展示（无需钱包连接）
- 简化的用户体验

#### 6. 八字计算模块 (后端)
**功能描述：**
- 公历转农历
- 计算天干地支
- 生成八字命盘
- 五行分析

**技术实现：**
- Python 日期计算
- 农历算法实现
- 天干地支映射
- 数据结构化输出

### 数据流程

```
用户输入数据
    ↓
前端验证和预处理
    ↓
发送到后端 API
    ↓
后端计算八字
    ↓
调用 AI API 分析
    ↓
生成结构化报告
    ↓
返回前端展示
    ↓
渲染报告和图表
```

### API 接口设计

**POST /api/analyze**
- 请求体：
  ```json
  {
    "name": "用户姓名",
    "gender": "男/女",
    "birthDate": "YYYY-MM-DD",
    "birthTime": "HH:mm",
    "screenshot": "base64图片数据",
    "csvData": "CSV文本内容"
  }
  ```
- 响应体：
  ```json
  {
    "bazi": {...},
    "analysis": "AI分析文本",
    "predictions": [
      {
        "month": "2026-01",
        "high": 85,
        "low": 60,
        "average": 72
      }
    ]
  }
  ```

### 性能优化

1. **前端优化：**
   - Vite 快速构建
   - 组件懒加载
   - 图片压缩
   - 依赖精简（64MB）

2. **后端优化：**
   - API 响应缓存
   - 异步处理
   - 错误重试机制

3. **AI 调用优化：**
   - 多 AI 服务备选
   - 超时控制
   - 错误降级

### 安全考虑

1. **数据安全：**
   - 无持久化存储用户数据
   - HTTPS 加密传输
   - CORS 跨域保护

2. **API 安全：**
   - API Key 环境变量管理
   - 请求频率限制
   - 输入验证和清洗

3. **前端安全：**
   - XSS 防护
   - 敏感信息不存储
   - 安全的第三方库

### 部署流程

1. **前端部署：**
   ```bash
   npm run build
   vercel deploy
   ```

2. **后端部署：**
   ```bash
   pip install -r requirements.txt
   python app.py
   ```

3. **环境变量配置：**
   - GEMINI_API_KEY
   - QWEN_API_KEY
   - CLAUDE_API_KEY
   - DEEPSEEK_API_KEY

### 未来扩展

1. 用户账户系统
2. 历史报告存储
3. 社交分享功能
4. 移动端适配
5. 多语言支持
6. 实时支付验证
